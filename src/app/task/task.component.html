<div class="task-wrapper g-025" data-consider-for-overlapping-checks="true" [class.editor-active]="this.editorActive" [class.selected]="this.selected" [class.archived]="this.task.status === 'archived'" [class]="this.task.status" [style]="this.task.priority === 4 ? 'font-weight: bolder' : ''" (click)="clickTask()">
    <div [tooltip]="'Drag'" *ngIf="!isStaticView() && !isPlaceholder()" class="drag-handle translucent pointer" drag-on-this="true" draggable="true">⋮</div>

    <prioritizer *ngIf="!isPlaceholder()" (onPrioritySelected)="updatePriority($event)" [container]="task" class=""> </prioritizer>
    <status [container]="task" [board]="board" [staticLane]="isStaticView()" (onStatusSelected)="updateStatus($event)" class="m-x-025"></status>

    <div class="flex w-100 g-025">

        @if (enableGanttView) {
        <div innerHTML="{{task.textContent}}"></div>
        }@else if (task.searchTextContent) {
        <div innerHTML="{{task.searchTextContent}}"></div>
        }@else {
        <div class="task-text-content grow" [class.placeholder]="isPlaceholder()" #editor contenteditable="true" [preventEvents]="!editorActive" [board]="board" [(ngModel)]="task.textContent" (ngModelChange)="debounceBoardUpdate()" (onTagsChange)="updateTaskTags($event)"></div>
        }

        <div *ngIf="!enableGanttView" class="task-toolbar relative flex align-items-center g-025">
            <span *ngIf="!isPlaceholder() && task.children.length === 0" [class.selected]="(task.gantt?.startDate || task.gantt?.endDate) && task.gantt?.showData !== false" class="select-dates pointer" (click)="openDatePicker()">
                <span *ngIf="task.gantt?.recurrence" [tooltip]="'Recurrent (' + task.gantt?.recurrence + ')'" [position]="'top'">↻</span>
                <span [tooltip]="'Set start/end dated'" [position]="'top'">📅</span>
                <date-picker *ngIf="showDatePicker" [showRecurrences]="true" [startDate]="fromIsoString(task.gantt?.startDate)" [endDate]="fromIsoString(task.gantt?.endDate)" [selectedRecurrence]="task.gantt?.recurrence" (onSetClicked)="setDates($event)" (onCancel)="setDates(undefined)"></date-picker>
            </span>

            <span *ngIf="!isPlaceholder()" [tooltip]="'Toggle show in Gantt chart'" [position]="'top'" [class.selected]="task.includeInGantt" (click)="toggleShowInGantt()" class="show-in-gantter pointer">
                📊
            </span>
            <span class="task-notes pointer" *ngIf="!isPlaceholder()" [tooltip]="(task.notes && task.notes.length > 0 ? 'Edit' : 'Create') +' task notes'" [position]="'top'" (click)="toggleShowNotes()" [class.selected]="task.notes && task.notes.length > 0" [class.open]="showNotes">
                🗒️
            </span>
            <notes [notes]="task.notes" (onNoteChanged)="storeNotes($event)" *ngIf="showNotes"></notes>
        </div>
    </div>
</div>
<div *ngIf="task.gantt && task.gantt.showData !== false" class="dates-n-stuff flex g-05 small">
    <div class="">
        <ng-container [ngTemplateOutlet]="datesText" [ngTemplateOutletContext]="{task:task}"></ng-container>
    </div>

</div>

<div *ngIf="showChildren" class="task-children-wrapper g-025 ">
    <ng-container *ngFor="let child of this.task.children; let last = last;trackBy: trackBy">
        <div class="flex">
            <div class="line">
                <div class="border-angle"></div>
                <div *ngIf="!last" class="border-line"></div>
            </div>
            <task [draggableDir]="task" [containerEl]="el.nativeElement" [layout]="'absolute'" class="child" [staticView]="isStaticView()" [parent]="this.task" [task]="child" [board]="this.board" [lane]="this.lane"></task>
        </div>
    </ng-container>

</div>

<ng-template #datesText let-task="task">
    @if(task.gantt){
    <span class="translucent">
        @if(isRecurringGanttTask(task)){
        {{task.gantt.recurrence}} - next
        }@else{
        planned
        }
    </span>
    <span [innerHTML]="getProximityIcons(task.gantt.nextRecurrenceStartDate ?? task.gantt.startDate, 'start')"></span>
    <ng-container [ngTemplateOutlet]="date" [ngTemplateOutletContext]="{date: task.gantt.nextRecurrenceStartDate ?? task.gantt.startDate }"></ng-container>
    @if( task.gantt.startDate !== task.gantt.endDate){
    <span class="translucent"> ⤳ </span>
    <span [innerHTML]="getProximityIcons(task.gantt.nextRecurrenceEndDate ?? task.gantt.endDate,'end')"></span>
    <ng-container [ngTemplateOutlet]="date" [ngTemplateOutletContext]="{date: task.gantt.nextRecurrenceEndDate ?? task.gantt.endDate }"></ng-container>
    <span class="translucent"> ({{getDiffInDays(this.task.gantt.startDate, this.task.gantt.endDate)}} day{{getDiffInDays(this.task.gantt.startDate, this.task.gantt.endDate) != 1 ? "s": ""}})</span>
    }
    }
    @if(task.status === 'archived'){
    <span class="translucent">, archived </span>
    <ng-container [ngTemplateOutlet]="date" [ngTemplateOutletContext]="{date: this.task.dates.archived?.enter }"></ng-container>
    <time-bar [container]="task"></time-bar>
    }

    @if(task.status === 'completed'){
    <span class="translucent">, completed </span>
    <ng-container [ngTemplateOutlet]="date" [ngTemplateOutletContext]="{date: this.task.dates.completed?.enter }"></ng-container>
    }
</ng-template>

<ng-template #date let-date="date">
    @if(getDiffInDays(getToday(), date) > 0){
    <span class="half-translucent pointer" [tooltip]="formatDate(date,'fullDateFormat') + ' - in ' + getDiffInDays(getToday(), date) + ' day' + ( getDiffInDays(getToday(), date) != 1 ? 's' : '' )">{{formatDate(date)}}</span>
    }@else if(getDiffInDays(getToday(), date) == 0){
    <span class="half-translucent pointer" [tooltip]="formatDate(date,'fullDateFormat') + ' - today'">{{formatDate(date)}}</span>
    }
    @else{
    <span class="half-translucent pointer" [tooltip]="formatDate(date,'fullDateFormat') + ' - ' + -getDiffInDays(getToday(), date) + ' day' + ( -getDiffInDays(getToday(), date) != 1 ? 's' : '' ) + ' ago'">{{formatDate(date)}}</span>
    }
</ng-template>